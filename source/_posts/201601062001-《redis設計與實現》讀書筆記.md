title: 《Redis設計與實現》讀書筆記　—— 第一部分 第二章  
date: 2016-01-06 20:02:03
categories: 技術
tags: 
- Redis
---
> 閱讀《redis設計與實現》一書筆記
> 作者黃建宏，90年生【90后啊啊啊啊啊
> 第一章主要介紹本書的一些概況以及建議的學習步驟，這裡不記錄，從真正正文Redis第一部分開始

<!--more-->

### 第一部分 數據結構與對象

### 2.簡單動態字符串SDS ( Simple Dynamic String ) 
> Redis中 C字符串只會用於字面量(比如：日誌打印的時候)，需要更改的字符串則使用SDS結構.
> 鍵值對的鍵與值分別保存著字符串XX的SDS結構
> SDS用作緩衝區(比如：AOF緩衝區，客戶端狀態中的輸入緩衝區)

## 2.1 SDS的定義
<img src="/images/Redis/2016-01-06_0001.jpg"  />
```
len:記錄buf數組中已使用的字節數量，也就是SDS字符串保存的字符串長度，這個長度，不包含'\0'空字符，SDS自動為字符串數組增加一個'\0'空字符位
free：未使用的字節數
buf[]:保存字符串，並且以'\0'結尾的字符串，如同C語言一樣，可以直接複用C語言的字符串函數
----
C字符串遍歷需操作複雜度O(N),而SDS本身擁有len屬性，表示字符串長度，遍歷需要O(1)複雜度，性能提升，即使反復使用strlen命令，也不會造成性能影響
C字符串不記錄長度本身，防止緩衝區溢出，對應拼接操作，內存重新分配，需要長度擴容，如果忘記這一步，會造成緩衝區溢出，
 對於截斷操作，同樣需要重新分配內存，需要長度縮短，忘記這一步，會造成內存洩露。
對於Redis緩存數據庫來講，頻繁的進行內存重新分配，嚴重影響性能。為了避免C語言字符串操作的這種缺陷，
SDS通過未使用空間free來解除字符串長度和底層數組長度的關聯。
兩種優化策略：空間預分配與惰性空間釋放
1、預分配空間：減少連續執行字串增長操作所需的內存重新分配次數,必定N次==》最多N次
1》小於1MB數據，free = len = buf數據長度
2》大於1MB數據，free = 1MB數據空間 len = buf數據長度
2、惰性釋放空間：字符串縮短操作，並不是立即內存充分配，而是將釋放的空間用free標記==》為將來可能有的增長操作做優化
SDS同樣提供API來讓我們真正的釋放未使用空間，不會造成內存浪費。
```

## 2.2二進制安全
C字符串只能保存字符，必須符合某種規範ASCII，如果有空格，會被默認為字符截斷('\0')，而SDS稱之為字節數組，保存內容由len屬性值判斷字符串是否結束，
而不是空格，不僅僅可以保存字符，同樣可保存各種二進制數據

## 2.3兼容C字符串函數
SDS結構遵循C字符串以空字符結尾的慣例，可以在有需要的時候，重用<string.h>函數，避免不必要的代碼重複。

## 2.4C字符串與SDS之間的對比
<img src="/images/Redis/2016-01-27_0001.jpg"  />

## 2.5重點回顧
<img src="/images/Redis/2016-01-27_0002.jpg"  />



